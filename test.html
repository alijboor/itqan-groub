<!DOCTYPE html>
<html>
    <head>
        <link rel='stylesheet' href='indess.css'>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    </head>
    <body>
        <div class="search">
            <input type="text" placeholder="Search" id="search">
            <button class="btn btn-primary mb-2" onclick="open_popup_by_value()">Search</button>
        </div>
        <br>
        
        <div id="datatable">
        </div>
        <div id="childparent">
        </div>
        
        <div class="save">
            <button class="btn btn-success mb-2" onclick="saveData()" >حفظ</button>
        </div>
        
        <div class="bg-modal">
            <div class="modal-contents">
                <div class="close">+</div>
                <div class="content-pop">
                    <p id="NameOfItem"></p>
                    <p id="QuanOfItem"></p>

                    <input type="text" id="idnonDisplay" name="idnonDisplay" style="display: none;" >
                    <select id="state" disabled name="state">
                        <option value="B"></option>
                        <option id="green" style='background-color:LimeGreen' value="G">تم التجهيز</option>
                        <option id="red" style='background-color:red' value="R">غير جاهز</option>
                        <option id="pink" style='background-color:rgb(240, 15, 146)' value="M">تجهيز جزئي</option>
                    </select>
                    <div class="number-input">
                        <!-- <button onclick="this.parentNode.getElementById('quantity').stepUp()" class="plus"></button> -->
                        <button onclick="dec()">-</button>
                        <input type="number" id="quantity" name="quantity" min="0" step="1" readonly onchange="on_Edit()">
                        <button onclick="inc()">+</button>  

                        <!-- <button onclick="this.parentNode.getElementById('quantity').stepDown()" ></button> -->
                    </div>
                    <a href="#" class="btn btn-success" onclick="Update_data()">حفظ</a>
                </div>
            </div>
        </div>

        <div class="parent-modal">
            <div class="modal-contents">
                <div class="close" id="parentClose">+</div>
                <div class="content-pop">
                    <p id="defaultweight"></p>
                    <p id="approximateweight"> :الوزن التقريبي </p>
                    <div class="act-weight">
                        <input type="text" id="actualweight" name="actualweight" > -: الوزن الفعلي </input>
                    </div>

                    <input type="text" id="idnonDisplay" name="idnonDisplay" style="display: none;" >
                    <select id="state" disabled name="state">
                        <option value="B"></option>
                        <option id="green" style='background-color:LimeGreen' value="G">تم التجهيز</option>
                        <option id="red" style='background-color:red' value="R">غير جاهز</option>
                        <option id="pink" style='background-color:rgb(240, 15, 146)' value="M">تجهيز جزئي</option>
                    </select>
                    <a href="#" class="btn btn-success" onclick="Update_data()">حفظ</a>
                </div>
            </div>
        </div>
        
        
        <script>
            var all_data;
            var child_ctr = 0;

            
            //var parent_child_data;
            $.post("/testorderitem.php", {webToken : document.cookie},  function (data , stauts){
                data = JSON.parse(data);
                all_data = data;
                var datTable='';
                var parentHead = [];
                var parent_child_data = '';

                for (let j = 0; j < data.length; j++) {
                    all_data[j].push(0);// add bool col. for check visit for items details
                    if(data[j][4] == 'G'){
                        status_ar = 'تم التجهيز';
                    }
                    else if(data[j][4] == 'R'){
                        status_ar = 'غير جاهز';
                    }
                    else if(data[j][4].substring(0, 1) == 'M'){
                        status_ar = 'تجهيز جزئي';
                    }
                    else{ 
                        status_ar = '';
                    }

                    if(data[j][5] == 'a_store'){
                        datTable += "<tr id='row"+j+"'><td>" + data[j][2]+ "</td>";
                        datTable += "<td>" + data[j][1]+ "</td><td id='idst"+j+"'>" + status_ar + "</td><td>" + data[j][3]+ "</td> <td> <button href='#' onclick='open_popup()' class='btn btn-danger' >Check item</button> </td> <td></tr>";
                    }
                    else {
                        if(data[j][5] == 'a_al'){
                            parentHead.push(data[j]);
                            parent_child_data +="<tr id='row"+j+"'><td>" + data[j][2]+ "</td>";
                            parent_child_data += "<td>" + data[j][1]+ "</td><td id='idst"+j+"'>" + status_ar + "</td><td>" + data[j][3]+ "</td> <td> <button href='#' onclick='open_parent_popup()' class='btn btn-danger' >Check item</button> </td> <td></tr>";

                        }
                        if(data[j][5] == 'b_al'){
                            parent_child_data += "<tr id='row"+j+"'><td style='text-align: center;'>" + data[j][2]+ "</td>";
                            parent_child_data += "<td>" + data[j][1]+ "</td><td id='idst"+j+"'>" + status_ar + "</td><td>" + data[j][3]+ "</td> <td> <button href='#' onclick='open_popup()' class='btn btn-danger' >Check item</button> </td> <td></tr>";

                        }
                        // parent_child_data += "<tr id='row"+j+"'><td>" + data[j][2]+ "</td>";
                        // parent_child_data += "<td>" + data[j][1]+ "</td><td id='idst"+j+"'>" + status_ar + "</td><td>" + data[j][3]+ "</td> <td> <button href='#' onclick='open_popup()' class='btn btn-danger' >Check item</button> </td> <td></tr>";
                    }
                }
                // insert childs into parent row as array
                for (let parentCTR = 0; parentCTR < parentHead.length; parentCTR++) {
                    for (let childCTR = 0; childCTR < data.length; childCTR++) {
                        if(data[childCTR][5] == 'b_al' && data[childCTR][7].substring(0,4) ==  parentHead[parentCTR][7]){
                            parentHead[parentCTR].push(data[childCTR]);
                        }  
                    }
                }
                var table = `
                    <div>
                        <table class="table table-sm" id="table-data">
                            <thead>
                                <tr>
                                    <th scope="col">إسم الصنف</th>
                                    <th scope="col">الكمية المطلوبة</th>
                                    <th scope="col">حالة الصنف</th>
                                    <th scope="col">باركود</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody>`+datTable+`</tbody>
                        </table>	
                    </div>
                `;

                var par_child = `
                    <br>
                    <div>
                        <table class="table table-sm" id="table-data">
                            <thead>
                                <tr>
                                    <th scope="col">إسم الصنف</th>
                                    <th scope="col">الكمية المطلوبة</th>
                                    <th scope="col">حالة الصنف</th>
                                    <th scope="col">باركود</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody>`+parent_child_data+`</tbody>
                        </table>	
                    </div>
                `;
                $('#datatable').append(table);
                $('#childparent').append(par_child);
            });

            var static_quan = 0;
            var static_index = 0;

            // open item pop up by value
            function open_popup_by_value() {
                document.getElementById('defaultweight').innerHTML = '';

                document.getElementById('NameOfItem').innerHTML = '';
                document.getElementById('QuanOfItem').innerHTML = '';
                var val = document.getElementById('search').value;
                var isfound=0;
                for (let i = 0; i < all_data.length; i++) {
                    if(all_data[i][5] == 'a_al' && all_data[i][3] == val && val != ''){
                        document.querySelector('.parent-modal').style.display = "flex";
                        // need edit
                        var calc = 0;

                        for (let index = 0; index < all_data.length  ; index++) {
                            if(all_data[index][6].substring(0,4) == all_data[i][7]){
                                calc += Number(all_data [static_index][9])* Number(all_data [static_index][8]) * Number(all_data [static_index][1]) ;
                            }
                        }
                        var NameShouldShowHere = document.getElementById("defaultweight");
                        NameShouldShowHere.textContent += "الوزن الافتراضي : "+ Number(calc);
                        isfound = 1;
                        static_index = i;

                    }
                    else{
                        if(all_data[i][3] == val && val != ''){
                            document.querySelector('.bg-modal').style.display = "flex";
                            document.getElementById("quantity").value = all_data[i][1];
                            static_quan = all_data[i][1];
                            document.getElementById("quantity").max = all_data[i][1];
                            on_Edit();
                            document.getElementById('idnonDisplay').value = all_data[i][0];
                            isfound = 1;
                            static_index = i;
                            var NameShouldShowHere = document.getElementById("NameOfItem");
                            NameShouldShowHere.textContent += ": اسم المنتج "+all_data [static_index][2];
                            var quanshouldshownhere = document.getElementById('QuanOfItem');
                            quanshouldshownhere.textContent += " الكمية المطلوبة للتجهيز :  " + all_data [static_index][1];

                        }
                    }
                }

                if(!isfound)
                   alert("barecode are not avilable here OR the box is Empty\n try again");
            }
        
            
            function on_Edit(){
                var quan = document.getElementById("quantity").value;
                if (quan == 0){
                    document.getElementById("red").selected = 'selected';
                }
                else if(quan == static_quan){
                    document.getElementById("green").selected = 'selected';
                }
                else {
                    document.getElementById("pink").selected = 'selected';
                }
            }
        
            function Update_data(){
                var status = '';
                if(document.getElementById("state").value == 'M')
                    status = document.getElementById("state").value+"█"+ document.getElementById("quantity").value;
                else
                    status = document.getElementById("state").value;
                all_data [static_index][4] = status;
                all_data[static_index][10]=1;
                var elem = "idst"+static_index;
                var rowid= "row"+static_index;
                document.getElementById(elem).value = all_data [static_index][4];
                if(all_data [static_index][4] == 'G'){
                    document.getElementById(elem).innerHTML = 'تم التجهيز';
                    document.getElementById(rowid).style.backgroundColor = "LimeGreen";
                }
                else if(all_data [static_index][4] == 'R'){
                    document.getElementById(elem).innerHTML = 'غير جاهز';
                    document.getElementById(rowid).style.backgroundColor = "red";
                }
                else if(all_data [static_index][4].substring(0, 1) == 'M'){
                    document.getElementById(elem).innerHTML = 'تجهيز جزئي';
                    document.getElementById(rowid).style.backgroundColor = "rgb(240, 15, 146)";
                }
                document.querySelector('.bg-modal').style.display = "none";
            }
        
            function saveData(){
                for (let i = 0; i < all_data.length; i++) {
                    $.post("/updateitem.php?idnonDisplay="+all_data[i][0]+ "&state="+all_data[i][4], {
                        webToken : document.cookie},
                        function (data , stauts){
                        console.log('0');    
                    });
                }
                window.location.reload();
                // var jsonData = JSON.stringify(all_data);
                // console.log(jsonData);
                // $.ajax({
                //         type: "POST",
                //         url: "updateitem.php",
                //         data: {data : jsonData}, 
                //         cache: false,
        
                //         success: function(){
                //             alert("تم");
                //         }
                //     });
            }

            // open item pop up
            function open_popup() {
                document.querySelector('.bg-modal').style.display = "flex";
            }

            // close item pop up
            document.querySelector('.close').addEventListener("click", function() {
            document.querySelector('.bg-modal').style.display = "none";
            });

            // open parent pop up
            function open_parent_popup() {
                document.querySelector('.parent-modal').style.display = "flex";
            }

            // close parent pop up
            document.querySelector('#parentClose').addEventListener("click", function() {
            document.querySelector('.parent-modal').style.display = "none";
            });


            document.querySelector("#search").addEventListener('keyup', function(e){
                if(e.keyCode === 13){
                    open_popup_by_value();
                }   
            })

            function inc(){
                let number = document.querySelector('[name="quantity"]');
                if (parseInt(number.value) < parseInt(number.max)){
                    number.value = parseInt(number.value) + 1;
                    on_Edit();
                }
            }

            function dec(){
                let number = document.querySelector('[name="quantity"]');
                if (parseInt(number.value) > 0) {
                    number.value = parseInt(number.value) - 1;
                    on_Edit();
                }
            }

        </script>
        
    </body>    
</html>
